---
# inventory-service AuthorizationPolicy â€” L4-only (no waypoint proxy in Ambient mode).
# ztunnel cannot enforce HTTP attributes (methods, paths) without a waypoint.
# Layer 7 separation is achieved at the gateway level: the HTTPRoute only exposes
# public GET endpoints (/stock, /health). POST /reserve is not routed externally.
# At L4, ztunnel verifies the SPIFFE principal for internal mTLS calls.
# NOTE: The Istio gateway pod runs in the 'infra' namespace.
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: inventory-service-policy
  namespace: inventory
spec:
  selector:
    matchLabels:
      app: inventory-service
  rules:
    # Allow external traffic via Istio gateway (GET /stock, GET /health)
    - from:
        - source:
            namespaces: ["infra"]
    # Allow ecom-service SA for POST /reserve (mTLS, pod-to-pod, bypasses gateway)
    # and ui-service nginx proxy for /inven/* (both in ecom namespace).
    # ztunnel verifies ecom-service calls using the SPIFFE principal at L4.
    - from:
        - source:
            namespaces: ["ecom"]
